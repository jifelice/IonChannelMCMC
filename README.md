# IonChannelMCMC

This repository contains the R code to explore the parameter space of an ion channel kinetic model.

## Contents
The following source codes are necessary for performing the exploration and must be placed in a source directory that is defined in the second line of the code: AJUSTEcall.R and AJUSTEcallTT.R with the variable: "directorioFuentes". To perform stage 1/stage 2 the codes AJUSTEcall.R/AJUSTEcallTT.R must be executed. They call other subprograms that are also listed below.

_**AJUSTEcall.R**_

Runs stage 1. Arguments are read from the file _**Parametros.R**_ in /additional\_files directory. 

_**AJUSTEcallTT.R**_

Runs stage 2. Arguments are read from the file _**ParametrosTT.R**_ in /additional\_files directory.

_**AJUSTEcoreDIAG.R**_

Calculates the Po vs t curves.

_**AJUSTEcoreMCMC.R**_

Performs _N<sub>c</sub>_ cycles of Monte Carlo steps at stage 1.

_**AJUSTEcoreMCMCTT.R**_

Performs _N<sub>c</sub>_ cycles of Monte Carlo steps at stage 2.

_**AJUSTEdensfunction.R**_

Calculates $d^2$

_**AJUSTEmatrizHVCN1.R**_

Calculates de W matrix for the model considered as an example.

_**AJUSTEinforme.R**_ and _**AJUSTEinformeTT.R**_ save to .txt files the initial values used in the simulations for stage1 and stage2, respectively. 

## Brief Description of the Methodology and Program Functions

This method involves the exploration of the parameter space of an ion channel model using Monte Carlo Markov chains (MCMC). A probability density is defined that reaches its maximum when the model reproduces the open probabilities obtained from experimental whole-cell currents. The probability density used to generate the chain becomes sharper following a sort of simulated annealing procedure, where a parameter sigma plays the role of temperature.

The method is designed to perform two stages. In stage 1, the space is traversed with a discrete step, and the step size and sigma are automatically adjusted based on the system's evolution (AJUSTEcall.R program). In the second stage, the space is traversed with a continuous step, where the maximum step size and sigma are arbitrarily defined beforehand (AJUSTEcallTT.R program).

### Stage 1:

_**AJUSTEcall.R**_

  Reads simulation parameters and model parameter ranges from the Parametros.R file, defining the region of the model parameter space to explore, the method of traversing the range for each parameter (linear or logarithmic), and other parameters associated with the model.

  Reads experimental open probabilities (obtained from whole-cell currents) used for fitting from the expData.txt file.
  
  Constructs the grid to traverse the parameter space.
  
  Determines initial values for model parameters, in case it is the start of the simulation. If the simulation was already initiated, it resumes with the values of model parameters and simulation parameters where it left off.
  
  Calculates open probabilities generated by the model.
  
  Determines initial distance and sigma.
  
  Prints all values of model parameters and simulation parameters at the beginning of the simulation.
  
  Calls the AJUSTEcoreMCMC routine, which performs the exploration of the space.

_**AJUSTEcoreMCMC.R**_

  Conducts several cycles of exploration of the model parameter space using MCMC.
  
  Each cycle of n Monte Carlo (MC) steps (nSteps) is carried out under conditions defined by a fixed grid of possible discrete parameter values (defined by the parameter N), and a probability density (ρ) defined by a distance between theoretical and experimental open probabilities, and a parameter sigma.
  
  The MC steps of the cycle are performed using the Metropolis algorithm.
  
  nSteps should be large enough for the chain states to mostly correspond to equilibrium states of ρ.
  
  Each cycle is defined by a grid of a given spacing and a sigma. Throughout the different cycles, N and sigma are automatically modified for each stage according to a decision algorithm based on the system's evolution.
  
  The program ends when a maximum number of cycles is reached or when the distance falls below a predefined value (d2Fin).
  
  Output files:  
    ResultadosFinal.txt writes the seed, q(i), i=1,...12, d2, and cycle number at the end of the process.
    
  evolucion.txt: writes cycle number, d2antes (before), d2despues (after), (d2antes-d2despues)/d2antes, sigma, N.
  arranque.txt: a piece of R code assigning values to some simulation parameters used if the program is used to continue a started simulation. Simulation parameters include:
      
   ciclo=value
      
   sigmaIni=value
    
   d2Ini=value
      
   Nini=value
      
   d2antes=value
      
  ValoresRes_ciclo_"n".txt and Valores_ciclo_"n".txt files store q and d2 values for each cycle "n", every nWrite steps within the cycle, or values at the end of the cycle, respectively.
    
### Stage 2:

_**AJUSTEcallTT.R**_

  Reads the same simulation and model parameters as AJUSTEcall.R from Parametros.R but also reads information from ParametrosTT.R for different cycles: the number of steps, sigma, and N for each stage.
  
  The initial values for the model parameters for this stage are the final ones from stage 1. If the simulation was already initiated, it resumes with the values of model parameters and simulation parameters where it left off.
 
  Prints all values of model parameters and simulation parameters at the beginning of the simulation.
  
  Calls the AJUSTEcoreMCMC.R routine, which performs the exploration of the space.
    
_**AJUSTEcoreMCMCTT.R**_

  Conducts several cycles of exploration of the model parameter space using MCMC.
  
  Throughout the different cycles, N and sigma are modified according to values specified by AJUSTEcallTT.R.
    
Output files:
  ResultadosFinalTT.txt writes q(i), i=1,...12, and d2 at the end of the process.
    
  evolucionTT.txt: writes cycle number, d2antes (before), d2despues (after), (d2antes-d2despues)/d2antes, sigma, N.
  
  arranqueTTreanuda.txt: a piece of R code assigning values to some simulation parameters used if the program is used to continue a started simulation. Parameters include:
        
  ciclo=value
  
  q=value
  
  d2Ini=value
  
  ValoresRes_ciclo_TT_"n".txt and Valores_ciclo_TT_"n".txt files store q and d2 values for each cycle "n" every nWrite steps within the cycle, or values at the end of the cycle, respectively.

Both MCMC routines (AJUSTEcoreMCMC.R and AJUSTEcoreMCMCTT.R) call the AJUSTEmatrizHVCN1.R, AJUSTEdensfunc.R, and AJUSTEcoreDIAG.R files.

_**AJUSTEmatrizHVCN1.R**_

Calculates the matrix W containing the transition probability rates among states, calculated from the model parameters q and a given voltage V. This version is implemented for a four-state model C1-C2-C3-O, where each transition rate depends on the voltage as follows: rate(V) = rate0 * exp(aZV/kT), where rate0 and Z are two model parameters, and a = 1 or a = -1 depending on whether it is a direct or inverse reaction.

_**AJUSTEcoreDIAG.R**_

  Calculates the values of theoretical open probabilities Po(V,t) by solving the equation dP/dt = WP, with W(V) calculated using AJUSTEmatrizHVCN1.R, and P(V,0) = p0, which is read from Parametros.R.

_**AJUSTEdensfunct.R**_

  Calculates the mean square distance between theoretical open probabilities (theorData) and experimental open probabilities (expData) for all voltages (read from Parametros.R) and considered times (determined from expData.txt).
